(()=>{"use strict";class t{constructor(t,e){this.chunks=[],this.recorder=null,this.element=t,this.type=e,this.error=null}async createRecord(){try{let t;"audio"===this.type?t=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}):"video"===this.type&&(t=await navigator.mediaDevices.getUserMedia({audio:!1,video:!0})),this.recorder=new MediaRecorder(t),this.recorder.addEventListener("start",(()=>{console.log("recording started")})),this.recorder.addEventListener("dataavailable",(t=>{console.log("data available"),this.chunks=[],this.chunks.push(t.data)})),this.recorder.addEventListener("stop",(()=>{console.log("recording stopped");const t=new Blob(this.chunks);this.element.src=URL.createObjectURL(t)})),this.recorder.start()}catch(t){this.error=t.message}}}class e{constructor(){this.timelineRecords=document.querySelector(".timeline-records"),this.timelineInputText=document.querySelector(".timeline-input-text"),this.message=null,this.modal=document.querySelector(".modal"),this.modalInput=document.querySelector(".modal-input-text"),this.coordinates=null,this.ok=document.querySelector(".modal-ok"),this.cancel=document.querySelector(".modal-cancel"),this.error=document.querySelector(".input-error"),this.audioBtn=document.querySelector(".timeline-input-audio"),this.videoBtn=document.querySelector(".timeline-input-video"),this.timer=document.querySelector(".timer"),this.recorder=null,this.createElement=null,this.timerId=null,this.min=0,this.sec=0}events(){this.inputText(),this.inputTextEnter(),this.inputCoordinates(),this.clickModalOk(),this.clickModalCancel(),this.clickAudioVideo(this.videoBtn),this.clickAudioVideo(this.audioBtn)}addRecord(t){if(null===this.coordinates)this.modal.classList.remove("none");else{const i=document.createElement("div"),s=document.createElement("div"),n=document.createElement("div"),o=document.createElement("p"),a=document.createElement("div");if(n.appendChild(o),n.appendChild(a),i.appendChild(s),"string"==typeof t){const e=document.createElement("div");i.appendChild(e),e.textContent=t.trim()}else i.appendChild(t);i.appendChild(n),i.classList.add("record"),s.classList.add("record-date"),a.classList.add("img-coordinates"),n.classList.add("coordinates"),s.textContent=e.getDate(),this.timelineRecords.appendChild(i),o.textContent=this.coordinates,this.message=null,this.createElement=null,this.coordinates=null}}async geo(){this.coordinates=await async function(){return new Promise((t=>{navigator.geolocation||t(null),navigator.geolocation.getCurrentPosition((e=>{const{latitude:i,longitude:s}=e.coords;t(`[${i}, ${s}]`)}),(()=>{t(null)}))}))}()}timerRec(){this.min=0,this.sec=0,this.timerId=setInterval((()=>{60===this.sec&&(this.min+=1,this.sec=0),this.min<10&&this.sec<10?this.timer.textContent=`0${this.min}:0${this.sec}`:this.min<10&&this.sec>9?this.timer.textContent=`0${this.min}:${this.sec}`:this.min>9&&this.sec<10?this.timer.textContent=`${this.min}:0${this.sec}`:this.min>9&&this.sec>9&&(this.timer.textContent=`${this.min}:${this.sec}`),this.sec+=1}),1e3)}async transformButtonsOn(){await this.geo(),this.timer.classList.remove("none"),this.timerRec(),this.videoBtn.classList.remove("image-video"),this.videoBtn.classList.add("image-cancel"),this.audioBtn.classList.remove("image-audio"),this.audioBtn.classList.add("image-ok")}transformButtonsOff(){this.timer.classList.add("none"),this.videoBtn.classList.add("image-video"),this.videoBtn.classList.remove("image-cancel"),this.audioBtn.classList.add("image-audio"),this.audioBtn.classList.remove("image-ok")}async record(e){this.createElement=document.createElement(e),this.createElement.controls=!0,this.recorder=new t(this.createElement,e),await this.recorder.createRecord(),window.MediaRecorder&&null===this.recorder.error?this.transformButtonsOn():(await async function(){window.Notification&&(new Notification(`Sample notification ${new Date}`,{body:"Необходимо выдать право на запись или использовать другой браузер!",requireInteraction:!0}),console.log(Notification.permission),"granted"!==Notification.permission&&("denied"===Notification.permission&&"default"!==Notification.permission||Notification.requestPermission()))}(),this.recorder=null,this.createElement=null)}cancelRecord(){clearInterval(this.timerId),this.min=0,this.sec=0,this.timer.textContent="",this.recorder.recorder.stop(),this.transformButtonsOff()}clickAudioVideo(t){t.addEventListener("click",(()=>{this.timer.classList.contains("none")&&t.classList.contains("image-audio")?this.record("audio"):this.timer.classList.contains("none")&&t.classList.contains("image-video")?this.record("video"):!this.timer.classList.contains("none")&&t.classList.contains("image-ok")?(this.cancelRecord(),this.addRecord(this.createElement)):!this.timer.classList.contains("none")&&t.classList.contains("image-cancel")&&this.cancelRecord()}))}inputText(){this.timelineInputText.addEventListener("input",(t=>{this.message=t.target.value}))}async inputTextEnter(){this.timelineInputText.addEventListener("keyup",(t=>{"Enter"===t.key&&null!==this.message&&this.requestGeo()}))}async requestGeo(){await this.geo(),null!==this.coordinates?(this.addRecord(this.message),this.timelineInputText.value=null):null===this.coordinates&&(this.modal.classList.remove("none"),this.timelineInputText.value=null)}inputCoordinates(){this.modalInput.addEventListener("input",(t=>{const e=t.target.value,i=e.split(","),s=i[0].trim(),n=i[1].trim();(function(t){const e=t.split(","),i=e[0].trim(),s=e[1].trim();return!(!/^\[?-?\d{1,2}\.\d{1,9}\]?$/.test(i)||!/^\[?-?\d{1,2}\.\d{1,9}\]?$/.test(s))})(e)&&(this.coordinates=`[${s}, ${n}]`)}))}clickModalOk(){this.ok.addEventListener("click",(()=>{null===this.coordinates?this.inputError():null!==this.message?(this.modal.classList.add("none"),this.addRecord(this.message),this.modalInput.value=null):null!==this.createElement&&(this.modal.classList.add("none"),this.addRecord(this.createElement),this.modalInput.value=null)}))}clickModalCancel(){this.cancel.addEventListener("click",(()=>{this.coordinates=null,this.modalInput.value=null,this.modal.classList.toggle("none")}))}inputError(){this.error.classList.remove("none"),setTimeout((()=>this.error.classList.add("none")),3e3)}static getDate(){const t=(new Date).getFullYear();let e=(new Date).getMonth()+1,i=(new Date).getDate(),s=(new Date).getHours(),n=(new Date).getMinutes();return 1===String(e).length&&(e=`0${e}`),1===String(i).length&&(i=`0${i}`),1===String(n).length&&(n=`0${n}`),1===String(s).length&&(s=`0${s}`),`${i}.${e}.${String(t).slice(2)} ${s}:${n}`}}console.log("app started"),(new e).events()})();